<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ал-Хоразмий</title>
    <link rel="icon" href="./../assets/media/images/generals/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="./../assets/css/styles.css">
</head>
<body>
    <!-- /Header start -->
    <header>
        <div class="container">
            <div class="row">
                <div class="col-sm-3 logo ps-4 pt-2 text-center text-sm-start">
                    <img src="./../assets/media/images/generals/logo.png" alt="Logo">
                </div>
                <div class="col-sm-9">
                    <h1 class="d-none">Конференция Аль-Хорезми</h1>
                    <p class="entry p-4">IX-Международная научная конференция «Актуальные проблемы прикладной математики и информационных технологий – Аль-Хорезми 2024» 22-23 октябрь. Ташкент.</p>
                </div>
                <div class="d-flex justify-content-evenly d-md-block position-relative">
                    <div class="sign-in d-inline-block">
                        <a class="btn" href="./auth/login.html" id="header-sign-in">Вход</a>
                    </div>
                    <div class="language-menu d-inline-block">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">RU</button>
                            <ul class="dropdown-menu">
                                <li><button class="dropdown-item language" id="uz">UZ</button></li>
                                <li><button class="dropdown-item language" id="en">EN</button></li>
                            </ul>
                        </div>
                    </div>
                    <div class="custom-menu d-inline-block d-md-none">
                        <div class="custom-dropdown">
                            <button class="btn custom-dropdown-toggle">
                                <span class="text-truncate">Главная</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                                    <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                </svg>
                            </button>
                            <ul class="custom-dropdown-menu position-absolute list-unstyled d-none">
                                <li><a href="./index.html" class="custom-dropdown-item px-2 py-1 d-block">Главная</a></li>
                                <li><a href="./organizers.html" class="custom-dropdown-item px-2 py-1 d-block">Организаторы</a></li>
                                <li><a href="./speakers.html" class="custom-dropdown-item px-2 py-1 d-block">Приглашенные Спикеры</a></li>
                                <li><a href="./participants.html" class="custom-dropdown-item px-2 py-1 d-block">Участники</a></li>
                                <li><a href="./important-dates.html" class="custom-dropdown-item px-2 py-1 d-block">Важные даты</a></li>
                                <li><a href="./auth/registr.html" class="custom-dropdown-item px-2 py-1 d-block">Регистрация</a></li>
                                <li><a href="./sections.html" class="custom-dropdown-item px-2 py-1 d-block">Разделы</a></li>
                                <li><a href="./submission.html" class="custom-dropdown-item px-2 py-1 d-block">Правила оформления</a></li>
                                <li><a href="./conference-venue.html" class="custom-dropdown-item px-2 py-1 d-block">Место проведения</a></li>
                                <li><a href="./accommodation.html" class="custom-dropdown-item px-2 py-1 d-block">Размещение</a></li>
                                <li><a href="./social-program.html" class="custom-dropdown-item px-2 py-1 d-block">Социальная программа</a></li>
                                <li><a href="./conference-fees.html" class="custom-dropdown-item px-2 py-1 d-block">Сборы за конференцию</a></li>
                                <li><a href="./program.html" class="custom-dropdown-item px-2 py-1 d-block">Программа</a></li>
                                <li><a href="./sponsors.html" class="custom-dropdown-item px-2 py-1 d-block">Спонсоры</a></li>
                                <li><a href="./contacts.html" class="custom-dropdown-item px-2 py-1 d-block">Контакты</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- /Header end -->
    
    <main>
        <div class="container p-0">
            <!-- Navbar start -->
            <nav class="navbar navbar-expand d-none d-md-flex">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse justify-content-center" id="navbarNavDropdown">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="./index.html">Главная</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./organizers.html">Организаторы</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./speakers.html">Приглашенные Спикеры</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./participants.html">Участники</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <!-- /Navbar end -->

            <div class="row mt-3 mx-0">
                <div class="col-md-4 d-none d-md-block">
                    <menu class="m-0 p-0">
                        <div class="list-group rounded-0">
                            <a href="./important-dates.html" class="list-group-item list-group-item-action bordered">Важные даты</a>
                            <a href="./auth/registr.html" class="list-group-item list-group-item-action bordered">Регистрация</a>
                            <a href="./sections.html" class="list-group-item list-group-item-action bordered">Разделы</a>
                            <a href="./submission.html" class="list-group-item list-group-item-action bordered">Правила оформления</a>
                            <a href="./conference-venue.html" class="list-group-item list-group-item-action bordered">Место проведения</a>
                            <a href="./accommodation.html" class="list-group-item list-group-item-action bordered">Размещение</a>
                            <a href="./social-program.html" class="list-group-item list-group-item-action bordered">Социальная программа</a>
                            <a href="./conference-fees.html" class="list-group-item list-group-item-action bordered">Сборы за конференцию</a>
                            <a href="./program.html" class="list-group-item list-group-item-action bordered">Программа</a>
                            <a href="./sponsors.html" class="list-group-item list-group-item-action bordered">Спонсоры</a>
                            <a href="./contacts.html" class="list-group-item list-group-item-action bordered">Контакты</a>
                        </div>
                    </menu>
                </div>

                <div class="col-md-8">
                    <aside class="profile custom-black-text">
                        <h2 class="page-heading fw-bold custom-black-text fs-3 mb-4">Профиль <button class="fs-5 fw-semibold" id="log-out">Выход</button></h2>

                        <div class="row g-3 mb-3 fs-5 fw-semibold pages">
                            <div class="col-sm-4 text-center informations-btn active-page"><a href="" id="informations-btn" data-target="informations">Информация</a></div>
                            <div class="col-sm-3 text-center articles-btn"><a href="" id="articles-btn" data-target="articles">Тезисы</a></div>
                            <div class="col-sm-5 text-center add-article-btn"><a class="d-none" href="" id="add-article-btn" data-target="add-article">Добавить тезис</a></div>
                        </div>
                        <div id="informations">
                            <ul class="list-unstyled ms-3 fs-5 fw-semibold">
                                <li>
                                    <span>Email:</span>  
                                    <span id="email"></span>
                                </li>
                                <li>
                                    <span>Имя:</span>
                                    <span id="first-name"></span>
                                </li>
                                <li>
                                    <span>Фамилия:</span>
                                    <span id="last-name"></span>
                                </li>
                                <li>
                                    <span>Пол:</span>
                                    <span id="gender"></span>
                                </li>
                                <li>
                                    <span>Институт:</span>
                                    <span id="institute"></span>
                                </li>
                                <li>
                                    <span>Специальность:</span>
                                    <span id="specialty"></span>
                                </li>
                                <li>
                                    <span>Страна:</span>
                                    <span id="country"></span>
                                </li>
                                <li>
                                    <span>Город:</span>
                                    <span id="city"></span>
                                </li>
                                <li>
                                    <span>Адрес:</span>
                                    <span id="address"></span>
                                </li>
                                <li>
                                    <span>Почтовый индекс:</span>
                                    <span id="postal-code"></span>
                                </li>
                                <li>
                                    <span>Телефон:</span>
                                    <span id="phone"></span>
                                </li>
                            </ul>
                        </div>
                        <div class="d-none" id="articles">
                            <div id="article-not-found" class="fs-5 fw-semibold"></div>
                            <ul class="list-unstyled ms-3 fs-5 fw-semibold" id="article-info">
                                <li>
                                    <span>Раздел:</span>  
                                    <span id="section-info"></span>
                                </li>
                                <li>
                                    <span>Тема:</span>  
                                    <span id="title-info"></span>
                                </li>
                                <li>
                                    <span>Описание:</span>
                                    <span id="description-info"></span>
                                </li>
                                <li>
                                    <span>Файл:</span>
                                    <a href="" id="file-info" download></a>
                                </li>
                            </ul>
                            <div class="fs-5 fw-semibold">
                                <a href="" class="ms-3" id="edit-btn">Редактировать</a>
                            </div>
                            <form class="row g-3 needs-validation d-none" novalidate id="articles-form">
                                <div class="col-12">
                                    <select class="form-select" id="section-article" required>
                                        <option selected disabled value="">-- Выберите раздел --</option>
                                        <option value="1">Научное наследие Аль-Хорезми</option>
                                        <option value="2">Математическое моделирование</option>
                                        <option value="3">Вычислительная и дискретная математика</option>
                                        <option value="4">Дифференциальные уравнения и уравнения математической физики. Обратные и некорректные задачи</option>
                                        <option value="5">Искусственный интеллект</option>
                                        <option value="6">Математический анализ и его приложения</option>
                                        <option value="7">Информационная безопасность</option>
                                        <option value="8">Компьютерная лингвистика</option>
                                        <option value="9">Информационные технологии в образовании</option>
                                        <option value="10">Теория вероятностей и математическая статистика</option>
                                        <option value="11">Алгебра, геометрия и функциональный анализ</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Пожалуйста, выберите раздел.
                                    </div>
                                </div>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="title-article" placeholder="Тема" required>
                                    <div class="invalid-feedback">
                                        Пожалуйста, введите тему.
                                    </div>
                                </div>
                                <div class="form-floating">
                                    <textarea class="form-control" placeholder="Leave a comment here" id="description-article"></textarea>
                                    <label for="description-article">Описание</label>
                                </div>
                                <div class="col-12">
                                    <input class="form-control" type="file" id="file-article" required>
                                </div>
                                <div class="col-12">
                                    <button class="btn w-100" type="submit">Редактировать</button>
                                </div>
                            </form>
                        </div>

                        <div class="d-none" id="add-article">
                            <form class="row g-3 needs-validation" novalidate id="add-article-form">
                                <div class="col-12">
                                    <select class="form-select" id="section" required>
                                        <option selected disabled value="">-- Выберите раздел --</option>
                                        <option value="1">Научное наследие Аль-Хорезми</option>
                                        <option value="2">Математическое моделирование</option>
                                        <option value="3">Вычислительная и дискретная математика</option>
                                        <option value="4">Дифференциальные уравнения и уравнения математической физики. Обратные и некорректные задачи</option>
                                        <option value="5">Искусственный интеллект</option>
                                        <option value="6">Математический анализ и его приложения</option>
                                        <option value="7">Информационная безопасность</option>
                                        <option value="8">Компьютерная лингвистика</option>
                                        <option value="9">Информационные технологии в образовании</option>
                                        <option value="10">Теория вероятностей и математическая статистика</option>
                                        <option value="11">Алгебра, геометрия и функциональный анализ</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Пожалуйста, выберите раздел.
                                    </div>
                                </div>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="title" placeholder="Тема" required>
                                    <div class="invalid-feedback">
                                        Пожалуйста, введите тему.
                                    </div>
                                </div>
                                <div class="form-floating">
                                    <textarea class="form-control" placeholder="Leave a comment here" id="description"></textarea>
                                    <label for="description">Описание</label>
                                </div>
                                <div class="col-12">
                                    <input class="form-control" type="file" id="file" required>
                                </div>
                                <div class="col-12">
                                    <button class="btn w-100" type="submit">Создавать</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-12" id="message"></div>
                    </aside>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer start -->
    <footer class="footer py-4 mt-3">
        <div class="container">
            <p class="m-0 ps-3">IX-Международная научная конференция «Актуальные проблемы прикладной <br>  математики и информационных технологий – Аль-Хорезми 2024»</p>
        </div>
    </footer>
    <!-- /Footer end -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <script src="./../assets/js/uz-ru-scripts.js"></script>
    <script src="./../assets/js/main.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // === Auth tekshirish ===
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user) {
                window.location.href = "./auth/login.html";
                return;
            }

            document.getElementById("log-out").addEventListener("click", function () {
                localStorage.removeItem("user");
                window.location.href = "./auth/login.html";
            });

            // === Navbar navigatsiyasi ===
            document.querySelectorAll('a[data-target]').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    document.querySelectorAll('#informations, #articles, #add-article').forEach(div => {
                        div.classList.add('d-none');
                    });

                    document.querySelectorAll('.informations-btn, .articles-btn, .add-article-btn').forEach(btn => {
                        btn.classList.remove('active-page');
                    });

                    const targetId = this.getAttribute('data-target');
                    const targetDiv = document.getElementById(targetId);
                    if (targetDiv) targetDiv.classList.remove('d-none');

                    this.parentElement.classList.add('active-page');
                });
            });

            // === Maqola holatini yuklash ===
            const userId = user.id;
            const apiUrl = "http://127.0.0.1:8000/api/maqola";
            const editBtn = document.getElementById("edit-btn");
            const articlesForm = document.getElementById("articles-form");
            const articleInfo = document.getElementById("article-info");
            const articleNotFound = document.getElementById("article-not-found");
            const addArticleBtn = document.getElementById("add-article-btn");

            let currentArticleId = null;

            function loadUserArticle() {
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        const userArticle = data.find(article => article.author.id === userId);
                        if (userArticle) {
                            currentArticleId = userArticle.id;
                            addArticleBtn.classList.add("d-none");
                            editBtn.classList.remove("d-none");
                            articleInfo.classList.remove("d-none");
                            articleNotFound.classList.add("d-none");

                            document.getElementById("section-info").textContent = document.getElementById("section").querySelector(`option[value="${userArticle.category.id}"]`).textContent;
                            document.getElementById("title-info").textContent = userArticle.title;
                            document.getElementById("description-info").textContent = userArticle.content;

                            const fileLink = document.getElementById("file-info");
                            fileLink.href = `http://127.0.0.1:8000/api/api/maqolalar/${userArticle.id}/download`;
                            fileLink.textContent = userArticle.file;
                        } else {
                            articleInfo.classList.add("d-none");
                            editBtn.classList.add("d-none");
                            addArticleBtn.classList.remove("d-none");
                            articleNotFound.innerHTML = "Вы ещё не создали ни одной статьи.";
                        }
                    })
                    .catch(error => {
                        console.error("Xatolik yuz berdi:", error);
                    });
            }

            loadUserArticle();

            // === Tahrirlash bosqichi ===
            editBtn.addEventListener("click", function (e) {
                e.preventDefault();
                editBtn.classList.add("d-none");
                articleInfo.classList.add("d-none");
                articlesForm.classList.remove("d-none");

                document.getElementById('title-article').value = document.getElementById("title-info").textContent.trim();
                document.getElementById('description-article').value = document.getElementById("description-info").textContent.trim();

                const currentSection = document.getElementById("section-info").textContent.trim();
                const sectionSelect = document.getElementById('section-article');
                Array.from(sectionSelect.options).forEach(option => {
                    if (option.textContent.trim() === currentSection) {
                        option.selected = true;
                    }
                });
            });

            articlesForm.addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData();
                formData.append("title", document.getElementById("title-article").value);
                formData.append("content", document.getElementById("description-article").value);
                formData.append("category_id", document.getElementById("section-article").value);

                const fileInput = document.getElementById('file-article');
                if (fileInput && fileInput.files.length > 0) {
                    formData.append("file", fileInput.files[0]);
                }

                fetch(`${apiUrl}/${currentArticleId}/`, {
                    method: "PATCH",
                    body: formData,
                })
                    .then(response => {
                        if (!response.ok) throw new Error("Tahrirlashda xatolik yuz berdi");
                        return response.json();
                    })
                    .then(updated => {
                        showAlert("Статья успешно отредактирована!", "success");
                        document.getElementById("section-info").textContent =
                            document.getElementById("section").querySelector(`option[value="${updated.category.id}"]`).textContent;
                        document.getElementById("title-info").textContent = updated.title;
                        document.getElementById("description-info").textContent = updated.content;
                        document.getElementById("file-info").href = updated.file;
                        document.getElementById("file-info").textContent = updated.file;

                        articlesForm.classList.add("d-none");
                        articleInfo.classList.remove("d-none");
                        editBtn.classList.remove("d-none");
                    })
                    .catch(error => {
                        console.log(error.message);
                        showAlert("Упс! Что-то пошло не так. Пожалуйста, попробуйте снова.", "danger");
                    });
            });

            // === Yangi maqola qo‘shish ===
            document.getElementById('add-article-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const form = this;

                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                const formData = new FormData();
                formData.append('author_id', userId);
                formData.append('category_id', document.getElementById('section').value);
                formData.append('title', document.getElementById('title').value);
                formData.append('content', document.getElementById('description').value);
                formData.append('file', document.getElementById("file").files[0]);

                try {
                    const response = await fetch(apiUrl + '/', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert("Статья успешно создана!", "success");
                        form.reset();
                        form.classList.remove('was-validated');

                        document.getElementById("articles").classList.remove("d-none");
                        document.getElementById("add-article").classList.add("d-none");
                        document.querySelector(".articles-btn").classList.add("active-page");
                        document.getElementById("add-article-btn").classList.add("d-none");

                        loadUserArticle();
                    } else {
                        showAlert("Упс! Что-то пошло не так. Пожалуйста, попробуйте снова.", "danger");
                    }
                } catch (error) {
                    showAlert("Упс! Что-то пошло не так. Пожалуйста, попробуйте снова.", "danger");
                    console.error(error);
                }
            });

            // === showAlert funksiyasi ===
            function showAlert(message, type = "success", duration = 3000) {
                const box = document.getElementById("message");
                box.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}</div>`;

                setTimeout(() => {
                    const alert = box.querySelector('.alert');
                    if (alert) {
                        alert.classList.remove("show");
                        alert.classList.add("hide");
                        setTimeout(() => alert.remove(), 300);
                    }
                }, duration);
            }

            // === Profil ma’lumotini ko‘rsatish ===
            document.getElementById("email").textContent = user.email;
            document.getElementById("first-name").textContent = user.first_name;
            document.getElementById("last-name").textContent = user.last_name;
            document.getElementById("gender").textContent = user.gender;
            document.getElementById("institute").textContent = user.institute;
            document.getElementById("specialty").textContent = user.specialty;
            document.getElementById("country").textContent = user.country;
            document.getElementById("city").textContent = user.city;
            document.getElementById("address").textContent = user.address;
            document.getElementById("postal-code").textContent = user.postal_code;
            document.getElementById("phone").textContent = user.phone;
        });
    </script>

</body>
</html>